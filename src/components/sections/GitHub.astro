---
import Section from "../Section.astro";
import { basics } from "@cv";

const githubProfile = basics.profiles.find((p) => p.network === "GitHub");
const username = githubProfile?.username ?? "Saimon8420";
const chartUrl = `https://ghchart.rshah.org/${username}`;
const profileUrl = `https://github.com/${username}`;

interface Repo {
  name: string;
  html_url: string;
  description: string | null;
  language: string | null;
  stargazers_count: number;
  forks_count: number;
}

const languageColors: Record<string, string> = {
  JavaScript: "#f1e05a",
  TypeScript: "#3178c6",
  Python: "#3572A5",
  Rust: "#dea584",
  Go: "#00ADD8",
  Java: "#b07219",
  HTML: "#e34c26",
  CSS: "#563d7c",
  Shell: "#89e051",
  C: "#555555",
  "C++": "#f34b7d",
  "C#": "#178600",
  Ruby: "#701516",
  PHP: "#4F5D95",
  Dart: "#00B4AB",
  Kotlin: "#A97BFF",
  Swift: "#F05138",
  Vue: "#41b883",
  Astro: "#ff5a03",
  SCSS: "#c6538c",
  EJS: "#a91e50",
  Jupyter: "#DA5B0B",
};

let repos: Repo[] = [];
let fetchError = false;

try {
  const res = await fetch(
    `https://api.github.com/users/${username}/repos?sort=pushed&per_page=30&type=public`,
  );
  if (res.ok) {
    repos = await res.json();
  } else {
    fetchError = true;
  }
} catch {
  fetchError = true;
}
---

<Section
  className={`print:hidden ${Astro.props.className ?? ""}`}
  title="GitHub"
>
  <!-- Contribution Graph -->
  <div class="overflow-x-auto">
    <img
      src={chartUrl}
      alt={`${username}'s GitHub contribution graph`}
      class="w-full min-w-[350px] rounded-md dark:hue-rotate-180 dark:invert"
      loading="lazy"
    />
  </div>

  <!-- Repository List -->
  {
    repos.length > 0 ? (
      <div class="mt-6 grid grid-cols-1 gap-3 md:grid-cols-2 lg:grid-cols-3">
        {repos.map((repo) => (
          <a
            href={repo.html_url}
            target="_blank"
            rel="noopener noreferrer"
            class="group flex flex-col gap-2 rounded-md bg-skin-button-muted/50 p-4 shadow-sm ring-1 ring-skin-muted transition-colors hover:ring-skin-hue"
          >
            <span class="text-base font-medium text-skin-base decoration-dotted underline-offset-[5px] group-hover:text-skin-hue group-hover:underline">
              {repo.name}
            </span>
            {repo.description && (
              <span class="line-clamp-2 text-sm text-skin-muted">
                {repo.description}
              </span>
            )}
            <span class="mt-auto flex items-center gap-4 text-xs text-skin-muted">
              {repo.language && (
                <span class="flex items-center gap-1">
                  <span
                    class="inline-block size-3 rounded-full"
                    style={`background-color: ${languageColors[repo.language] ?? "#8b8b8b"}`}
                  />
                  {repo.language}
                </span>
              )}
              {repo.stargazers_count > 0 && (
                <span class="flex items-center gap-1">
                  <svg class="size-3.5" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M8 .25a.75.75 0 0 1 .673.418l1.882 3.815 4.21.612a.75.75 0 0 1 .416 1.279l-3.046 2.97.719 4.192a.75.75 0 0 1-1.088.791L8 12.347l-3.766 1.98a.75.75 0 0 1-1.088-.79l.72-4.194L.818 6.374a.75.75 0 0 1 .416-1.28l4.21-.611L7.327.668A.75.75 0 0 1 8 .25z" />
                  </svg>
                  {repo.stargazers_count}
                </span>
              )}
              {repo.forks_count > 0 && (
                <span class="flex items-center gap-1">
                  <svg class="size-3.5" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M5 5.372v.878c0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75v-.878a2.25 2.25 0 1 0-1.5 0v.878h-3v-.878a2.25 2.25 0 1 0-1.5 0ZM8 1.25a.75.75 0 0 0 0 1.5.75.75 0 0 0 0-1.5Zm-2.25 8a.75.75 0 0 0-.75.75v.878a2.25 2.25 0 1 0 1.5 0v-.878a.75.75 0 0 0-.75-.75ZM8 12.25a.75.75 0 0 0 0 1.5.75.75 0 0 0 0-1.5Zm3.25-3a.75.75 0 0 0-.75.75v.878a2.25 2.25 0 1 0 1.5 0v-.878a.75.75 0 0 0-.75-.75ZM12 12.25a.75.75 0 0 0 0 1.5.75.75 0 0 0 0-1.5Z" />
                  </svg>
                  {repo.forks_count}
                </span>
              )}
            </span>
          </a>
        ))}
      </div>
    ) : fetchError ? (
      <p class="mt-6 text-sm text-skin-muted">
        Unable to load repositories. Visit{" "}
        <a
          href={`${profileUrl}?tab=repositories`}
          target="_blank"
          rel="noopener noreferrer"
          class="text-skin-hue underline"
        >
          GitHub
        </a>{" "}
        to see all repos.
      </p>
    ) : null
  }

  <!-- View all link -->
  {
    repos.length > 0 && (
      <div class="mt-4 text-center">
        <a
          href={`${profileUrl}?tab=repositories`}
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-1 text-sm text-skin-muted transition-colors hover:text-skin-hue"
        >
          View all on GitHub
          <svg class="size-4" viewBox="0 0 16 16" fill="currentColor">
            <path d="M3.75 2h3.5a.75.75 0 0 1 0 1.5h-2.19l5.72 5.72a.75.75 0 1 1-1.06 1.06L4 4.56v2.19a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 3.25 2.5h.5Z" />
            <path d="M6.54 7.107a.75.75 0 0 1 0 1.06L4.907 9.8a.75.75 0 0 1-1.06-1.06L5.48 7.107a.75.75 0 0 1 1.06 0Z" />
          </svg>
        </a>
      </div>
    )
  }
</Section>
